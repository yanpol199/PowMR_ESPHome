substitutions:
  inverter_name: "Inverter"
  device_name: "powerstation"
  friendly_name: powerstation
  node_name: "powerstation"
  node_id: powerstation
  inverter_tx_pin: GPIO01
  inverter_rx_pin: GPIO03
  inverter_voltage_offset: "0"
  update_interval: 10s # Minimum 10s recommended to avoid duplicate command errors
  select_skip_updates: "6"
  read_skip_updates: "6"
  name: Battery
  bms0: "${name} bms0"
  external_components_source: github://syssi/esphome-jk-bms@main
  mac_address: C8:47:80:10:1D:21
  protocol_version: JK02_32S

esp32:
  board: esp32cam
  framework:
    type: esp-idf
#    version: 5.4.2
    advanced:
      disable_libc_locks_in_iram: true
      disable_vfs_support_termios: true
      disable_vfs_support_select: true
      disable_vfs_support_dir: true

esphome:
  name: "${device_name}"
  friendly_name: "${node_name}"
  comment: "Monitor and control a powerstation"
  min_version: 2025.11.0

psram:
  mode: quad
  speed: 80MHz

external_components:
  - source: ${external_components_source}
    refresh: 0s

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

web_server:
 port: 80
 local: true
#  ota: false
logger:
  level: WARN

time:
  - platform: homeassistant
    id: hass_time
api:
  encryption:
    key: !secret api_key
  reboot_timeout: 0s
bluetooth_proxy:
  active: True 
esp32_ble:
  max_connections: 9

ble_client:
  - mac_address: ${mac_address}
    id: client0

ota:
  - platform: esphome
    password: !secret ota_password

jk_bms_ble:
  - ble_client_id: client0
    protocol_version: ${protocol_version}
    throttle: 5s
    id: bms0

uart:
  - id: uart_inverter
    baud_rate: 2400
    tx_pin: ${inverter_tx_pin}
    rx_pin: ${inverter_rx_pin}

modbus:
  - id: modbus_inverter
    uart_id: uart_inverter
    send_wait_time: 250ms

modbus_controller:
  - id: smg_inverter
    address: 0x05
    modbus_id: modbus_inverter
    setup_priority: -10
    offline_skip_updates: 100
    command_throttle: 1s
    update_interval: ${update_interval}

switch:
  - platform: restart
    name: "Restart"
sensor:
# ============== BMS SENSORS ==============
  - platform: jk_bms_ble
    jk_bms_ble_id: bms0
    delta_cell_voltage:
      name: "${name} delta cell voltage"
      id: bms0_delta_cell_voltage
      entity_category: diagnostic
    average_cell_voltage:
      name: "${name} average cell voltage"
      entity_category: diagnostic
      id: bms0_average_cell_voltage
    total_voltage:
      name: "${name} total voltage"
      id: bms0_total_voltage
    current:
      name: "${name} current"
      entity_category: diagnostic
      id: bms0_current
    power:
      name: "${name} power"
      entity_category: diagnostic
      id: bms0_power
    charging_power:
      name: "${name} charging power"
      id: bms0_charging_power
      entity_category: diagnostic
    discharging_power:
      name: "${name} discharging power"
      entity_category: diagnostic
      id: bms0_discharging_power
    temperature_sensor_1:
      name: "${name} temperature sensor 1"
      entity_category: diagnostic
      id: bms0_temp_1
    temperature_sensor_2:
      name: "${name} temperature sensor 2"
      entity_category: diagnostic
      id: bms0_temp_2
    power_tube_temperature:
      name: "${name} MOS temperature"
      entity_category: diagnostic
      id: bms0_mos_temp
    state_of_charge:
      name: "${name} state of charge"
      id: bms0_soc
    capacity_remaining:
      name: "${name} capacity remaining"
      id: bms0_capacity_remaining
    total_battery_capacity_setting:
      name: "${name} total battery capacity setting"
      entity_category: diagnostic
      id: bms0_capacity_total
    charging_cycles:
      name: "${name} charging cycles"
      entity_category: diagnostic
      id: bms0_cycles
    balancing_current:
      name: "${name} balancing current"
      entity_category: diagnostic
      id: bms0_balancing_current
  
  - platform: template
    name: "${name} charge runtime"
    internal: true
    id: bms0_charge_runtime_h
    unit_of_measurement: "h"
    device_class: duration
    accuracy_decimals: 2
    lambda: |-
      if (!id(bms0_current).has_state() ||
          !id(bms0_capacity_remaining).has_state() ||
          !id(bms0_capacity_total).has_state())
        return NAN;

      float current = id(bms0_current).state;  // A
      if (current <= 0.2f) return 0.0f;  // нет заряда

      float full = id(bms0_capacity_total).state;   // Ah
      float remaining = id(bms0_capacity_remaining).state; // Ah

      float need = full - remaining;
      if (need <= 0.0f) return 0.0f;

      float hours = need / current;
      return hours;

  - platform: template
    name: "${name} discharge runtime"
    internal: true
    id: bms0_discharge_runtime_h
    unit_of_measurement: "h"
    device_class: duration
    accuracy_decimals: 2
    lambda: |-
      if (!id(bms0_current).has_state() || !id(bms0_capacity_remaining).has_state())
        return NAN;

      float current = id(bms0_current).state;  // A
      float cap = id(bms0_capacity_remaining).state; // Ah

      if (current >= -0.2f) return 0.0f;  // нет разряда

      float hours = cap / fabs(current);
      return hours;
 
  ###################################
  # Read first group (14 registers) #
  ###################################

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "AC Voltage"
    id: grid_voltage
    address: 4502
    register_type: holding
    force_new_range: true
    register_count: 14
    skip_updates: 0
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      uint16_t raw = (uint16_t)x;
      uint16_t v = (raw >> 8) | ((raw & 0xFF) << 8);
      float value = v * 0.1;

      if (!id(grid_active).has_state() || !id(grid_active).state) {
        return 0.0f;
      }
      return value;

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "AC Frequency"
    address: 4503
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "Hz"
    device_class: frequency
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      uint16_t raw = (uint16_t)x;
      uint16_t v = (raw >> 8) | ((raw & 0xFF) << 8);
      return v * 0.1;

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "PV Voltage"
    address: 4504
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      uint16_t raw = (uint16_t)x;
      uint16_t v = (raw >> 8) | ((raw & 0xFF) << 8);
      return v * 0.1;

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "PV Power"
    address: 4505
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Battery Voltage"
    id: battery_voltage
    address: 4506
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 2
    lambda: |-
      uint16_t raw = (uint16_t)x;
      uint16_t v = (raw >> 8) | ((raw & 0xFF) << 8);
      return v * 0.1;

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Battery SoC"
    internal: True
    address: 4507
    register_type: holding
    value_type: U_WORD
    accuracy_decimals: 2
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Battery Charge Current"
    id: battery_charge_current
    address: 4508
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Battery Discharge Current"
    id: battery_discharge_current
    address: 4509
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Load Voltage"
    id: load_voltage
    address: 4510
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      uint16_t raw = (uint16_t)x;
      uint16_t v = (raw >> 8) | ((raw & 0xFF) << 8);
      return v * 0.1;

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Load Frequency"
    address: 4511
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "Hz"
    device_class: frequency
    state_class: measurement
    accuracy_decimals: 1
    lambda: |-
      uint16_t raw = (uint16_t)x;
      uint16_t v = (raw >> 8) | ((raw & 0xFF) << 8);
      return v * 0.1;

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Load VA Power"
    id: load_Power_VA
    address: 4512
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "VA"
    device_class: apparent_power
    state_class: measurement
    accuracy_decimals: 0
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Load Power"
    id: load_power
    address: 4513
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 0
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Load Percent"
    address: 4514
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "%"
    state_class: measurement
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Load Percent2"
    internal: True
    address: 4515
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "%"
    state_class: measurement
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Charger Source Priority"
    internal: True
    address: 4536
    register_type: holding
    value_type: U_WORD
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Output Source Priority"
    internal: True
    address: 4537
    register_type: holding
    value_type: U_WORD
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "AC Input Voltage Range"
    internal: True
    address: 4538
    register_type: holding
    value_type: U_WORD
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Target Output Frequency"
    internal: True
    address: 4540
    register_type: holding
    value_type: U_WORD
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Max Total Charging Current"
    internal: True
    accuracy_decimals: 0
    entity_category: diagnostic
    address: 4541
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "A"
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Target Output Voltage"
    internal: True
    accuracy_decimals: 0
    entity_category: diagnostic
    address: 4542
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Max Utility Charging Current"
    internal: True
    accuracy_decimals: 0
    entity_category: diagnostic
    address: 4543
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "A"
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Back To Utility Source Voltage"
    internal: True
    filters:
      - multiply: 0.1
    accuracy_decimals: 1
    entity_category: diagnostic
    address: 4544
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Back To Battery Source Voltage"
    internal: True
    filters:
      - multiply: 0.1
    accuracy_decimals: 1
    entity_category: diagnostic
    address: 4545
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Bulk Charging Voltage"
    internal: True
    filters:
      - multiply: 0.1
    accuracy_decimals: 1
    entity_category: diagnostic
    address: 4546
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Floating Charging Voltage"
    internal: True
    filters:
      - multiply: 0.1
    accuracy_decimals: 1
    entity_category: diagnostic
    address: 4547
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Low CutOff Voltage"
    internal: True
    filters:
      - multiply: 0.1
    accuracy_decimals: 1
    entity_category: diagnostic
    address: 4548
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Battery Equalization Voltage"
    internal: True
    filters:
      - multiply: 0.1
    accuracy_decimals: 1
    entity_category: diagnostic
    address: 4549
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Battery Equalized Time"
    internal: True
    accuracy_decimals: 0
    entity_category: diagnostic
    address: 4550
    register_type: holding
    value_type: U_WORD
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Battery Equalized Timeout"
    internal: True
    accuracy_decimals: 0
    entity_category: diagnostic
    address: 4551
    register_type: holding
    value_type: U_WORD
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Equalization Interval"
    internal: True
    accuracy_decimals: 0
    entity_category: diagnostic
    address: 4552
    register_type: holding
    value_type: U_WORD
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Charger Status"
    internal: True
    accuracy_decimals: 0
    entity_category: diagnostic
    address: 4555
    register_type: holding
    value_type: U_WORD
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Temperature"
    accuracy_decimals: 0
    entity_category: diagnostic
    address: 4557
    register_type: holding
    unit_of_measurement: "°C"
    value_type: U_WORD
    lambda: |-
      uint16_t raw = (uint16_t)x;
      return (raw >> 8) | ((raw & 0xFF) << 8);

text_sensor:
  - platform: template
    name: "${name} discharge time text"
    id: discharge_time_text
    lambda: |-
      if (!id(bms0_discharge_runtime_h).has_state())
        return std::string("Idle");

      float h = id(bms0_discharge_runtime_h).state;

      if (h <= 0.01f || std::isnan(h) || std::isinf(h))
        return std::string("Idle");

      int hh = (int) h;
      int mm = (int) ((h - hh) * 60.0f);

      if (hh < 0) hh = 0;
      if (mm < 0) mm = 0;

      char buf[16];
      snprintf(buf, sizeof(buf), "%dh%02dm", hh, mm);
      return std::string(buf);

  - platform: template
    name: "${name} charge time text"
    id: charge_time_text
    lambda: |-
      if (!id(bms0_charge_runtime_h).has_state())
        return std::string("Idle");

      float h = id(bms0_charge_runtime_h).state;

      if (h <= 0.01f || std::isnan(h) || std::isinf(h))
        return std::string("Idle");

      int hh = (int) h;
      int mm = (int) ((h - hh) * 60.0f);

      if (hh < 0) hh = 0;
      if (mm < 0) mm = 0;

      char buf[16];
      snprintf(buf, sizeof(buf), "%dh%02dm", hh, mm);
      return std::string(buf);

binary_sensor:
# ============== BMS SENSORS ==============
  - platform: jk_bms_ble
    balancing:
      name: "${name} balancing"
      entity_category: diagnostic
    charging:
      name: "${name} charging"
      entity_category: diagnostic
    discharging:
      name: "${name} discharging"
      entity_category: diagnostic
    online_status:
      name: "${name} online status"
      entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Alarm"
    entity_category: diagnostic
    address: 4535
    register_type: holding
    bitmask: 0x100

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    internal: True
    name: "Overload Bypass"
    entity_category: diagnostic
    address: 4535
    register_type: holding
    bitmask: 0x8000

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Load Off"
    address: 4553
    register_type: holding
    bitmask: 0x1000


  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Load Enabled"
    address: 4553
    register_type: holding
    bitmask: 0x4000

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "On Battery"
    id: inverter_on_battery
    address: 4554
    register_type: holding
    bitmask: 0x1

  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Grid Active"
    id: grid_active
    address: 4554
    register_type: holding
    bitmask: 0x8000

  # ####################################
  # # Read config registers one by one #
  # ####################################


select:
#Menu-5002
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Buzzer Alarm"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5002
    value_type: U_WORD
    optionsmap:
      "OFF": 0
      "ON": 1
#Menu-5004
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Backlight control"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5004
    value_type: U_WORD
    optionsmap:
      "OFF": 0
      "ON": 1
#Menu-5005
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Auto restart when overload"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5005
    value_type: U_WORD
    optionsmap:
      "OFF": 0
      "ON": 1
#Menu-5006
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Auto restart when overheat"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5006
    value_type: U_WORD
    optionsmap:
      "OFF": 0
      "ON": 1
#menu-5007
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Beep On Primary Source Fail"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5007
    value_type: U_WORD
    optionsmap:
      "OFF": 0
      "ON": 1
#menu-5008
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Auto return to default display screen"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5008
    value_type: U_WORD
    optionsmap:
      "OFF": 0
      "ON": 1
 #menu-5009
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Overload Bypass"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5009
    value_type: U_WORD
    optionsmap:
      "OFF": 0
      "ON": 1
 #menu-5010
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Record fault code"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5009
    value_type: U_WORD
    optionsmap:
      "OFF": 0
      "ON": 1
#menu-5017
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    id: charger_source_priority_select
    name: "Charger Source Priority"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5017
    value_type: U_WORD
    optionsmap:
      "Utility first": 0
      "Solar first": 1
      "Solar and Utility": 2
      "Only Solar": 3
#Menu-5018
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    id: output_source_priority_select
    name: "Output Source Priority"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5018
    value_type: U_WORD
    optionsmap:
      "Utility first (USB)": 0
      "Solar first (SUB)": 1
      "SBU priority": 2
#Menu-5019
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "AC input voltage range"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5019
    value_type: U_WORD
    optionsmap:
      "90-280VAC": 0
      "170-280VAC": 1
#Menu-5020
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Battery Type"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5020
    value_type: U_WORD
    optionsmap:
      "AGM": 0
      "Flooded": 1
      "User Defined": 2     
      "Litium": 3 
#Menu-5021
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Output frequency"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5021
    value_type: U_WORD
    optionsmap:
      "50Hz": 0
      "60Hz": 1
#Menu2-5022
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Max Total Charge Current"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5022
    value_type: U_WORD
    optionsmap:
      "10": 10
      "20": 20
      "30": 30
      "40": 40
      "50": 50
      "60": 60
      "70": 70
      "80": 80
#Menu-5023
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "AC output voltage"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5023
    value_type: U_WORD
    optionsmap:
      "220V": 220
      "230V": 230
      "240V": 240
#Menu-5024
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Max Utility Charge Current"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5024
    value_type: U_WORD
    optionsmap:
      "10": 10
      "20": 20
      "30": 30
      "40": 40
      "50": 50
      "60": 60
#Menu-5025
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Back To Utility Source Voltage"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5025
    value_type: U_WORD
    optionsmap:
      "21": 210
      "21.5": 215
      "22": 220
      "22.5": 225
      "23": 230
      "23.5": 235
      "24": 240
      "24.5": 245
      "25": 250
      "25.5": 255
#Menu-5026
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Back To Battery Source Voltage"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5026
    value_type: U_WORD
    optionsmap:
      "FULL": 0
      "24": 240
      "24.5": 245
      "25": 250
      "25.5": 255
      "26": 260
      "26.5": 265
      "27": 270
      "27.5": 275
      "28": 280    
      "28.5": 285
      "29": 290
  #Menu-5027
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Bulk charging voltage"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5027
    value_type: U_WORD
    optionsmap:
      "25.0": 250
      "25.1": 251
      "25.2": 252
      "25.3": 253
      "25.4": 254
      "25.5": 255
      "25.6": 256
      "25.7": 257
      "25.8": 258
      "25.9": 259
      "26.0": 260
      "26.1": 261
      "26.2": 262
      "26.3": 263
      "26.4": 264
      "26.5": 265
      "26.6": 266
      "26.7": 267
      "26.8": 268
      "26.9": 269
      "27.0": 270
      "27.1": 271
      "27.2": 272
      "27.3": 273
      "27.4": 274
      "27.5": 275
      "27.6": 276
      "27.7": 277
      "27.8": 278
      "27.9": 279
      "28.0": 280
      "28.1": 281
      "28.2": 282
      "28.3": 283
      "28.4": 284
      "28.5": 285
      "28.6": 286
      "28.7": 287
      "28.8": 288
      "28.9": 289
      "29.0": 290
      "29.1": 291
      "29.2": 292
      "29.3": 293
      "29.4": 294
      "29.5": 295
      "29.6": 296
      "29.7": 297
      "29.8": 298
      "29.9": 299
      "30.0": 300
      "30.1": 301
      "30.2": 302
      "30.3": 303
      "30.4": 304
      "30.5": 305
      "30.6": 306
      "30.7": 307
      "30.8": 308
      "30.9": 309
      "31.0": 310
      "31.1": 311
      "31.2": 312
      "31.3": 313
      "31.4": 314
      "31.5": 315

#Menu27 - 5028 
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Floating charging voltage"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5028
    value_type: U_WORD
    optionsmap:
      "25.0": 250
      "25.1": 251
      "25.2": 252
      "25.3": 253
      "25.4": 254
      "25.5": 255
      "25.6": 256
      "25.7": 257
      "25.8": 258
      "25.9": 259
      "26.0": 260
      "26.1": 261
      "26.2": 262
      "26.3": 263
      "26.4": 264
      "26.5": 265
      "26.6": 266
      "26.7": 267
      "26.8": 268
      "26.9": 269
      "27.0": 270
      "27.1": 271
      "27.2": 272
      "27.3": 273
      "27.4": 274
      "27.5": 275
      "27.6": 276
      "27.7": 277
      "27.8": 278
      "27.9": 279
      "28.0": 280
      "28.1": 281
      "28.2": 282
      "28.3": 283
      "28.4": 284
      "28.5": 285
      "28.6": 286
      "28.7": 287
      "28.8": 288
      "28.9": 289
      "29.0": 290
      "29.1": 291
      "29.2": 292
      "29.3": 293
      "29.4": 294
      "29.5": 295
      "29.6": 296
      "29.7": 297
      "29.8": 298
      "29.9": 299
      "30.0": 300
      "30.1": 301
      "30.2": 302
      "30.3": 303
      "30.4": 304
      "30.5": 305
      "30.6": 306
      "30.7": 307
      "30.8": 308
      "30.9": 309
      "31.0": 310
      "31.1": 311
      "31.2": 312
      "31.3": 313
      "31.4": 314
      "31.5": 315
  #Menu28 - 5029 
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Low DC cut-off voltage"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5029
    value_type: U_WORD
    optionsmap:
      "20.0": 200
      "20.1": 201
      "20.2": 202
      "20.3": 203
      "20.4": 204
      "20.5": 205
      "20.6": 206
      "20.7": 207
      "20.8": 208
      "20.9": 209
      "21.0": 210
      "21.1": 211
      "21.2": 212
      "21.3": 213
      "21.4": 214
      "21.5": 215
      "21.6": 216
      "21.7": 217
      "21.8": 218
      "21.9": 219
      "22.0": 220
      "22.1": 221
      "22.2": 222
      "22.3": 223
      "22.4": 224
      "22.5": 225
      "22.6": 226
      "22.7": 227
      "22.8": 228
      "22.9": 229
      "23.0": 230
      "23.1": 231
      "23.2": 232
      "23.3": 233
      "23.4": 234
      "23.5": 235
      "23.6": 236
      "23.7": 237
      "23.8": 238
      "23.9": 239
      "24.0": 240
  #Menu29 - 5030 
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Battery equalization voltage"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5030
    value_type: U_WORD
    optionsmap:
      "25.0": 250
      "25.1": 251
      "25.2": 252
      "25.3": 253
      "25.4": 254
      "25.5": 255
      "25.6": 256
      "25.7": 257
      "25.8": 258
      "25.9": 259
      "26.0": 260
      "26.1": 261
      "26.2": 262
      "26.3": 263
      "26.4": 264
      "26.5": 265
      "26.6": 266
      "26.7": 267
      "26.8": 268
      "26.9": 269
      "27.0": 270
      "27.1": 271
      "27.2": 272
      "27.3": 273
      "27.4": 274
      "27.5": 275
      "27.6": 276
      "27.7": 277
      "27.8": 278
      "27.9": 279
      "28.0": 280
      "28.1": 281
      "28.2": 282
      "28.3": 283
      "28.4": 284
      "28.5": 285
      "28.6": 286
      "28.7": 287
      "28.8": 288
      "28.9": 289
      "29.0": 290
      "29.1": 291
      "29.2": 292
      "29.3": 293
      "29.4": 294
      "29.5": 295
      "29.6": 296
      "29.7": 297
      "29.8": 298
      "29.9": 299
      "30.0": 300
      "30.1": 301
      "30.2": 302
      "30.3": 303
      "30.4": 304
      "30.5": 305
      "30.6": 306
      "30.7": 307
      "30.8": 308
      "30.9": 309
      "31.0": 310
      "31.1": 311
      "31.2": 312
      "31.3": 313
      "31.4": 314
      "31.5": 315
  #Menu33 - 5031 
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Battery equalized time"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5031
    value_type: U_WORD
    optionsmap:
      "5": 005
      "10": 010
      "15": 015
      "20": 020
      "25": 025
      "30": 030
      "35": 035
      "40": 040
      "45": 045
      "50": 050
      "55": 055
      "60": 060
      "65": 065
      "70": 070
      "75": 075
      "80": 080
      "85": 085
      "90": 090
      "95": 095
      "100": 100
      "105": 105
      "110": 110
      "115": 115
      "120": 120
      "125": 125
      "130": 130
      "135": 135
      "140": 140
      "145": 145
      "150": 150
      "155": 155
      "160": 160
      "165": 165
      "170": 170
      "175": 175
      "180": 180
      "185": 185
      "190": 190
      "195": 195
      "200": 200
      "205": 205
      "210": 210
      "215": 215
      "220": 220
      "225": 225
      "230": 230
      "235": 235
      "240": 240
      "245": 245
      "250": 250
      "255": 255
      "260": 260
      "265": 265
      "270": 270
      "275": 275
      "280": 280
      "285": 285
      "290": 290
      "295": 295
      "300": 300
      "305": 305
      "310": 310
      "315": 315
      "320": 320
      "325": 325
      "330": 330
      "335": 335
      "340": 340
      "345": 345
      "350": 350
      "355": 355
      "360": 360
      "365": 365
      "370": 370
      "375": 375
      "380": 380
      "385": 385
      "390": 390
      "395": 395
      "400": 400
      "405": 405
      "410": 410
      "415": 415
      "420": 420
      "425": 425
      "430": 430
      "435": 435
      "440": 440
      "445": 445
      "450": 450
      "455": 455
      "460": 460
      "465": 465
      "470": 470
      "475": 475
      "480": 480
      "485": 485
      "490": 490
      "495": 495
      "500": 500
      "505": 505
      "510": 510
      "515": 515
      "520": 520
      "525": 525
      "530": 530
      "535": 535
      "540": 540
      "545": 545
      "550": 550
      "555": 555
      "560": 560
      "565": 565
      "570": 570
      "575": 575
      "580": 580
      "585": 585
      "590": 590
      "595": 595
      "600": 600
      "605": 605
      "610": 610
      "615": 615
      "620": 620
      "625": 625
      "630": 630
      "635": 635
      "640": 640
      "645": 645
      "650": 650
      "655": 655
      "660": 660
      "665": 665
      "670": 670
      "675": 675
      "680": 680
      "685": 685
      "690": 690
      "695": 695
      "700": 700
      "705": 705
      "710": 710
      "715": 715
      "720": 720
      "725": 725
      "730": 730
      "735": 735
      "740": 740
      "745": 745
      "750": 750
      "755": 755
      "760": 760
      "765": 765
      "770": 770
      "775": 775
      "780": 780
      "785": 785
      "790": 790
      "795": 795
      "800": 800
      "805": 805
      "810": 810
      "815": 815
      "820": 820
      "825": 825
      "830": 830
      "835": 835
      "840": 840
      "845": 845
      "850": 850
      "855": 855
      "860": 860
      "865": 865
      "870": 870
      "875": 875
      "880": 880
      "885": 885
      "890": 890
      "895": 895
      "900": 900
  #Menu34 - 5032 Battery equalized timeout
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Battery equalized timeout"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5032
    value_type: U_WORD
    optionsmap:
      "5": 005
      "10": 010
      "15": 015
      "20": 020
      "25": 025
      "30": 030
      "35": 035
      "40": 040
      "45": 045
      "50": 050
      "55": 055
      "60": 060
      "65": 065
      "70": 070
      "75": 075
      "80": 080
      "85": 085
      "90": 090
      "95": 095
      "100": 100
      "105": 105
      "110": 110
      "115": 115
      "120": 120
      "125": 125
      "130": 130
      "135": 135
      "140": 140
      "145": 145
      "150": 150
      "155": 155
      "160": 160
      "165": 165
      "170": 170
      "175": 175
      "180": 180
      "185": 185
      "190": 190
      "195": 195
      "200": 200
      "205": 205
      "210": 210
      "215": 215
      "220": 220
      "225": 225
      "230": 230
      "235": 235
      "240": 240
      "245": 245
      "250": 250
      "255": 255
      "260": 260
      "265": 265
      "270": 270
      "275": 275
      "280": 280
      "285": 285
      "290": 290
      "295": 295
      "300": 300
      "305": 305
      "310": 310
      "315": 315
      "320": 320
      "325": 325
      "330": 330
      "335": 335
      "340": 340
      "345": 345
      "350": 350
      "355": 355
      "360": 360
      "365": 365
      "370": 370
      "375": 375
      "380": 380
      "385": 385
      "390": 390
      "395": 395
      "400": 400
      "405": 405
      "410": 410
      "415": 415
      "420": 420
      "425": 425
      "430": 430
      "435": 435
      "440": 440
      "445": 445
      "450": 450
      "455": 455
      "460": 460
      "465": 465
      "470": 470
      "475": 475
      "480": 480
      "485": 485
      "490": 490
      "495": 495
      "500": 500
      "505": 505
      "510": 510
      "515": 515
      "520": 520
      "525": 525
      "530": 530
      "535": 535
      "540": 540
      "545": 545
      "550": 550
      "555": 555
      "560": 560
      "565": 565
      "570": 570
      "575": 575
      "580": 580
      "585": 585
      "590": 590
      "595": 595
      "600": 600
      "605": 605
      "610": 610
      "615": 615
      "620": 620
      "625": 625
      "630": 630
      "635": 635
      "640": 640
      "645": 645
      "650": 650
      "655": 655
      "660": 660
      "665": 665
      "670": 670
      "675": 675
      "680": 680
      "685": 685
      "690": 690
      "695": 695
      "700": 700
      "705": 705
      "710": 710
      "715": 715
      "720": 720
      "725": 725
      "730": 730
      "735": 735
      "740": 740
      "745": 745
      "750": 750
      "755": 755
      "760": 760
      "765": 765
      "770": 770
      "775": 775
      "780": 780
      "785": 785
      "790": 790
      "795": 795
      "800": 800
      "805": 805
      "810": 810
      "815": 815
      "820": 820
      "825": 825
      "830": 830
      "835": 835
      "840": 840
      "845": 845
      "850": 850
      "855": 855
      "860": 860
      "865": 865
      "870": 870
      "875": 875
      "880": 880
      "885": 885
      "890": 890
      "895": 895
      "900": 900
  #Menu35 - 5033 Equalization interval
  - platform: modbus_controller
    modbus_controller_id: smg_inverter
    name: "Equalization interval"
    optimistic: true
    force_new_range: true
    register_count: 1
    skip_updates: ${select_skip_updates}
    entity_category: config
    address: 5033
    value_type: U_WORD
    optionsmap:
      "5": 005
      "10": 010
      "15": 015
      "20": 020
      "25": 025
      "30": 030
      "35": 035
      "40": 040
      "45": 045
      "50": 050
      "55": 055
      "60": 060
      "65": 065
      "70": 070
      "75": 075
      "80": 080
      "85": 085
      "90": 090
